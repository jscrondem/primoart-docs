# Описание технической архитектуры PrimoART

## Введение

### Общие сведения

Настоящий документ содержит описание технической архитектуры платформы «PrimoART».

---

## Описание программного обеспечения

### Архитектура решения PrimoART

![image](https://github.com/jscrondem/primoart-docs/blob/main/arch.png?raw=true)

**PrimoART** — это система мониторинга цифрового опыта (Digital Experience Monitoring), которая объединяет мониторинг реальных пользователей (RUM), мониторинг с использованием синтетических транзакций (STM), а также сбор и анализ метрик производительности и конфигурационных данных. Архитектура платформы разделена на несколько ключевых компонентов, обеспечивающих масштабируемость, гибкость и глубокий анализ данных.

### Основные компоненты архитектуры

#### Пользователи и взаимодействие с приложениями
- Пользователи взаимодействуют с инструментированными приложениями через **OpenTelemetry SDK**, которое собирает данные о действиях пользователей, метриках производительности, времени отклика, ошибках и других параметрах.
- Инструментированные приложения могут быть веб-сервисами или микросервисами, работающими на сервере приложений. Все метрики и трассировки направляются через OpenTelemetry SDK в **Коллектор данных**.

#### Синтетические роботы (STM)
- Роботы воспроизводят действия реальных пользователей в автоматическом режиме, выполняя синтетические транзакции для оценки производительности и доступности приложений.
- После выполнения транзакций роботы отправляют данные через API в формате **TransactionResultBaseModel**. Данные включают:
  - Информацию о транзакции,
  - Временные метки,
  - Длительность выполнения шагов,
  - Статус (успешно/ошибка).
- Результаты передаются на маршрут `/api/v1/transactions/results/upload`.

#### Коллектор данных (opentelemetry-collector)
- Коллектор агрегирует данные, поступающие от реальных пользователей через OpenTelemetry и результаты синтетических транзакций, отправленных роботами. Он собирает метрики, логи и трассировки для дальнейшей обработки

#### API Gateway
- API Gateway выполняет маршрутизацию запросов от внешних систем и сервисов к внутренним микросервисам системы PrimoART. Также он обеспечивает взаимодействие роботов с системой для передачи результатов тестирования и получения конфигурационных данных.

---

### Микросервисы PrimoART

1. **pa_apm**: Сервис логов и трассировок, ответственный за сбор и хранение данных о производительности.
2. **pa_events**: Сервис для обнаружения событий и их анализа.
3. **pa_ml**: Сервис машинного обучения для построения базовых линий (90 и 10 персентиль) и прогнозирования метрик.
4. **pa_synth**: Сервис управления роботами для выполнения синтетических транзакций и их конфигурации.
5. **pa_auth**: Сервис аутентификации и авторизации пользователей.
6. **pa_core**: Ядро системы для координации работы всех компонентов.

---

### Хранилища данных

- **victoriametrics**: Хранилище метрик производительности от реальных пользователей и синтетических транзакций. Используется для длительного хранения данных и их анализа.
- **victorialogs**: Хранилище логов, поступающих из различных источников, включая данные от роботов и приложений.
- **PostgreSQL**: Хранилище синтетических данных, профилей и прогнозов. Используется для сохранения данных, связанных с выполнением синтетических проверок.
- **MinIO**: Хранилище для артефактов (например, скриншоты от роботов при ошибочных транзакциях). В дальнейшем планируется расширить использование MinIO для хранения логов и других данных.
- **SQLite**: Локальное хранилище для моделей машинного обучения.


---

### Система управления событиями и инцидентами

- **VM-Alertmanager (VictoriaMetrics Alertmanager)**: Компонент, ответственный за управление оповещениями и инцидентами. Он отслеживает метрики и события из системы и отправляет уведомления о критических инцидентах.
- **Alerta**: Система управления событиями, которая также выполняет функцию оповещения при обнаружении проблем в производительности приложений или синтетических проверках.

---

### Процессы и взаимодействие компонентов

1. **Мониторинг реальных пользователей**:
   - Данные о действиях пользователей собираются через OpenTelemetry SDK и передаются в коллектор данных. Метрики производительности сохраняются в хранилищах victoriametrics и victorialogs для дальнейшего анализа.
2. **Синтетические проверки**:
   - Роботы имитируют действия пользователей и отправляют результаты выполнения синтетических транзакций в систему через API Gateway. Данные сохраняются в PostgreSQL и могут быть использованы для создания отчетов и прогнозов.
3. **Анализ и прогнозирование**:
   - Сервис машинного обучения (pa_ml) обрабатывает данные о производительности для создания прогнозов и базовых линий. Это позволяет системе предсказывать возможные проблемы и аномалии до того, как они начнут влиять на пользователей.
4. **Уведомления и оповещения**:
   - VM-Alertmanager и Alerta отслеживают события и метрики, отправляя уведомления ответственным пользователям при обнаружении инцидентов, проблем с производительностью или сбоях в работе системы.
5. **Хранение и анализ артефактов**:
   - Скриншоты и другие артефакты сохраняются в MinIO. В будущем MinIO будет использоваться для хранения дополнительных данных, таких как логи синтетических проверок.

---

### Масштабируемость и развертывание

PrimoART развертывается в контейнерах (Docker/Podman), что обеспечивает гибкость и легкость в управлении микросервисами. Компоненты системы могут масштабироваться горизонтально, что позволяет увеличивать производительность по мере роста нагрузки. Основные хранилища данных, такие как victoriametrics и PostgreSQL, могут быть настроены для кластеризации и повышения отказоустойчивости.

Система пока не тестировалась в среде Kubernetes, но поддержка контейнеризации позволяет адаптировать PrimoART для любых платформ оркестрации в будущем


